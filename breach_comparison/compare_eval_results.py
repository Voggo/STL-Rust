"""
Compare evaluation results from Breach and our RoSI approach.

This script compares the FINAL robustness intervals generated by both approaches
for matching formulas. It tracks the evolution of the interval for each time step
and compares the final converged values.
"""

from pathlib import Path
from collections import defaultdict
from typing import Dict
from tqdm import tqdm

from comparison import (
    extract_formula_number,
    find_matching_files,
    ComparisonResult,
    FormulaComparison,
    StrictComparisonResult,
    StrictFormulaComparison,
    read_results,
    read_strict_results,
    write_summary_table,
    write_strict_summary_table,
)


def process_rosi_comparisons() -> Dict[str, FormulaComparison]:
    """Process RoSI interval comparisons."""
    breach_dir = Path("results/breach/eval_results/rosi")
    rosi_dir = Path("results/own/eval_results/rosi")

    formula_comparisons: Dict[str, FormulaComparison] = defaultdict(
        lambda: FormulaComparison(formula_id="")
    )

    # Find all breach result files
    breach_files = find_matching_files(
        breach_dir, "breach_eval_results_F*_sizeN=5000_appr=rosi.csv"
    )

    print(f"Found {len(breach_files)} Breach (RoSI) result files")
    print(f"RoSI directory: {rosi_dir}")
    print()

    # ===== PROCESS RoSI COMPARISONS =====
    print("=" * 80)
    print("ROSI INTERVAL COMPARISON")
    print("=" * 80)

    for breach_file in tqdm(breach_files, desc="Processing RoSI comparisons"):
        formula_num = extract_formula_number(breach_file.name)
        if not formula_num:
            continue

        # Find corresponding RoSI file
        rosi_file = rosi_dir / f"eval_approach_F{formula_num}_sizeN=5000_appr=RoSI.csv"

        if not rosi_file.exists():
            tqdm.write(f"⚠️  Warning: No RoSI file for F{formula_num}")
            continue

        # Read results
        # Breach uses 'outputs_values', RoSI uses 'output_values'
        breach_results = read_results(breach_file, "output_values")
        rosi_results = read_results(rosi_file, "output_values")

        if not breach_results:
            tqdm.write(f"F{formula_num}: ❌ No Breach results read")
            continue

        if not rosi_results:
            tqdm.write(f"F{formula_num}: ❌ No RoSI results read")
            continue

        # Compare all time steps (union of both)
        all_steps = sorted(set(breach_results.keys()) | set(rosi_results.keys()))

        if not all_steps:
            tqdm.write(f"F{formula_num}: ❌ No time steps found")
            continue

        # Initialize formula comparison
        formula_cmp = FormulaComparison(formula_id=formula_num)

        # Compare each time step
        for step in all_steps:
            breach_interval = breach_results.get(step)
            rosi_interval = rosi_results.get(step)

            result = ComparisonResult(
                formula_id=formula_num,
                time_step=step,
                breach_interval=breach_interval,
                rosi_interval=rosi_interval,
            )
            result.check_consistency()
            formula_cmp.add_comparison(result)

        formula_comparisons[formula_num] = formula_cmp

    print("\n" + "=" * 80)
    print("RoSI SUMMARY")
    print("=" * 80)

    # Print summary for each formula
    total_violations = 0
    total_comparisons = 0

    for formula_num in sorted(formula_comparisons.keys(), key=lambda x: int(x)):
        cmp = formula_comparisons[formula_num]
        print(cmp)
        total_violations += cmp.violations_count
        total_comparisons += cmp.total_comparisons

    print("=" * 80)
    if total_comparisons > 0:
        overall_rate = (total_violations / total_comparisons) * 100
        print(
            f"OVERALL: {total_violations} violations out of {total_comparisons} comparisons ({overall_rate:.2f}%)"
        )
    else:
        print("No comparisons performed")

    return formula_comparisons


def process_strict_comparisons() -> Dict[str, StrictFormulaComparison]:
    """Process Strict value comparisons."""
    strict_breach_dir = Path("results/breach/eval_results/strict")
    strict_own_dir = Path("results/own/eval_results/strict")

    strict_comparisons: Dict[str, StrictFormulaComparison] = defaultdict(
        lambda: StrictFormulaComparison(formula_id="")
    )

    # Find all strict Breach result files
    strict_breach_files = find_matching_files(
        strict_breach_dir, "eval_approach_F*_sizeN=5000_appr=Strict.csv"
    )

    print(f"Found {len(strict_breach_files)} Breach (Strict) result files")
    print(f"Own Strict directory: {strict_own_dir}")
    print()

    # ===== PROCESS STRICT COMPARISONS =====
    print("=" * 80)
    print("STRICT VALUE COMPARISON")
    print("=" * 80)

    for breach_file in tqdm(strict_breach_files, desc="Processing Strict comparisons"):
        formula_num = extract_formula_number(breach_file.name)
        if not formula_num:
            continue

        # Find corresponding own Strict file
        own_file = strict_own_dir / f"eval_approach_F{formula_num}_sizeN=5000_appr=Strict.csv"

        if not own_file.exists():
            tqdm.write(f"⚠️  Warning: No own Strict file for F{formula_num}")
            continue

        # Read strict results
        breach_values = read_strict_results(breach_file)
        own_values = read_strict_results(own_file)

        if not breach_values:
            tqdm.write(f"F{formula_num}: ❌ No Breach values read")
            continue

        if not own_values:
            tqdm.write(f"F{formula_num}: ❌ No own values read")
            continue

        # Compare all time steps (union of both)
        all_steps = sorted(set(breach_values.keys()) | set(own_values.keys()))

        if not all_steps:
            tqdm.write(f"F{formula_num}: ❌ No time steps found")
            continue

        # Initialize strict formula comparison
        strict_cmp = StrictFormulaComparison(formula_id=formula_num)

        # Compare each time step
        for step in all_steps:
            breach_value = breach_values.get(step)
            own_value = own_values.get(step)

            result = StrictComparisonResult(
                formula_id=formula_num,
                time_step=step,
                breach_value=breach_value,
                rosi_value=own_value,
            )
            result.check_consistency()
            strict_cmp.add_comparison(result)

        strict_comparisons[formula_num] = strict_cmp

    print("\n" + "=" * 80)
    print("STRICT SUMMARY")
    print("=" * 80)

    # Print summary for each formula
    total_violations_strict = 0
    total_comparisons_strict = 0

    for formula_num in sorted(strict_comparisons.keys(), key=lambda x: int(x)):
        cmp = strict_comparisons[formula_num]
        print(cmp)
        total_violations_strict += cmp.violations_count
        total_comparisons_strict += cmp.total_comparisons

    print("=" * 80)
    if total_comparisons_strict > 0:
        overall_rate = (total_violations_strict / total_comparisons_strict) * 100
        print(
            f"OVERALL: {total_violations_strict} violations out of {total_comparisons_strict} comparisons ({overall_rate:.2f}%)"
        )
    else:
        print("No comparisons performed")

    return strict_comparisons


def print_violations_summary(
    formula_comparisons: Dict[str, FormulaComparison],
    strict_comparisons: Dict[str, StrictFormulaComparison],
):
    """Print detailed violations for both RoSI and Strict comparisons."""
    print("\n" + "=" * 80)
    print("DETAILED VIOLATIONS")
    print("=" * 80)

    # RoSI Violations
    print("\n### RoSI Interval Violations\n")
    has_violations = False
    for formula_num in sorted(formula_comparisons.keys(), key=lambda x: int(x)):
        cmp = formula_comparisons[formula_num]
        if cmp.violations_count > 0:
            has_violations = True
            print(f"\nF{formula_num} - {cmp.violations_count} violations:")

            # Show first 5 violations for this formula
            shown = 0
            for detail in cmp.comparison_details:
                if detail.has_violations() and shown < 5:
                    print(f"  Time {detail.time_step}: {detail.get_summary()}")
                    shown += 1

            remaining = (
                len([d for d in cmp.comparison_details if d.has_violations()]) - 5
            )
            if remaining > 0:
                print(f"  ... and {remaining} more violations")

    if not has_violations:
        print("✓ No RoSI violations found!")

    # Strict Violations
    print("\n### Strict Value Violations\n")
    has_violations_strict = False
    for formula_num in sorted(strict_comparisons.keys(), key=lambda x: int(x)):
        cmp = strict_comparisons[formula_num]
        if cmp.violations_count > 0:
            has_violations_strict = True
            print(f"\nF{formula_num} - {cmp.violations_count} violations:")

            # Show first 5 violations for this formula
            shown = 0
            for detail in cmp.comparison_details:
                if detail.has_violations() and shown < 5:
                    print(f"  Time {detail.time_step}: {detail.get_summary()}")
                    shown += 1

            remaining = (
                len([d for d in cmp.comparison_details if d.has_violations()]) - 5
            )
            if remaining > 0:
                print(f"  ... and {remaining} more violations")

    if not has_violations_strict:
        print("✓ No strict violations found!")


def write_detailed_log(
    formula_comparisons: Dict[str, FormulaComparison],
    strict_comparisons: Dict[str, StrictFormulaComparison],
):
    """Write detailed comparison results to log file."""
    log_file = Path("eval_comparison_log.txt")
    with open(log_file, "w") as f:
        f.write("EVALUATION RESULTS COMPARISON\n")
        f.write("=" * 80 + "\n\n")

        # RoSI Results
        f.write("## RoSI INTERVAL COMPARISON\n\n")
        for formula_num in sorted(formula_comparisons.keys(), key=lambda x: int(x)):
            cmp = formula_comparisons[formula_num]
            f.write(f"\nFormula F{formula_num}\n")
            f.write("-" * 80 + "\n")
            f.write(f"Total time steps checked: {cmp.total_comparisons}\n")
            f.write(f"Violations: {cmp.violations_count}\n")

            if cmp.violations_count > 0:
                f.write("\nViolation details:\n")
                for detail in cmp.comparison_details:
                    if detail.has_violations():
                        f.write(f"  Time {detail.time_step}: {detail.get_summary()}\n")

        # Strict Results
        f.write("\n\n## STRICT VALUE COMPARISON\n\n")
        for formula_num in sorted(strict_comparisons.keys(), key=lambda x: int(x)):
            cmp = strict_comparisons[formula_num]
            f.write(f"\nFormula F{formula_num}\n")
            f.write("-" * 80 + "\n")
            f.write(f"Total time steps checked: {cmp.total_comparisons}\n")
            f.write(f"Violations: {cmp.violations_count}\n")

            if cmp.violations_count > 0:
                f.write("\nViolation details:\n")
                for detail in cmp.comparison_details:
                    if detail.has_violations():
                        f.write(f"  Time {detail.time_step}: {detail.get_summary()}\n")

    print(f"\n✓ Detailed log written to {log_file}")


def main():
    """Main comparison function."""
    # Process both comparison types
    formula_comparisons = process_rosi_comparisons()
    strict_comparisons = process_strict_comparisons()

    # Print detailed violations
    print_violations_summary(formula_comparisons, strict_comparisons)

    # Write detailed log
    write_detailed_log(formula_comparisons, strict_comparisons)

    # Write summary tables
    if formula_comparisons:
        summary_file = Path("comparison_summary_rosi.md")
        write_summary_table(formula_comparisons, summary_file)

    if strict_comparisons:
        strict_summary_file = Path("comparison_summary_strict.md")
        write_strict_summary_table(strict_comparisons, strict_summary_file)


if __name__ == "__main__":
    main()
